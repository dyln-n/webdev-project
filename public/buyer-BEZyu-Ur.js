document.addEventListener("DOMContentLoaded",()=>{const m=document.getElementById("review-modal"),h=document.getElementById("thank-you-modal"),v=document.getElementById("shipped-modal"),y=document.getElementById("canceled-modal"),g=document.getElementById("edit-modal"),u=document.getElementById("product-review-fields"),f=document.getElementById("review-form"),w=document.getElementById("cancel-btn"),L=f.querySelector('button[type="submit"]');function l(){document.querySelectorAll(".arrow").forEach(t=>t.classList.remove("rotate"))}document.querySelectorAll(".toggle-review").forEach(t=>{t.addEventListener("click",async()=>{const s=t.dataset.orderId,a=t.dataset.status,c=t.querySelector(".arrow");if(l(),c.classList.add("rotate"),a==="delivered"){u.innerHTML="",f.action=`/buyer/orders/${s}/rate`;const d=await(await fetch(`/orders/${s}/ratings`)).json(),o=d.filter(e=>e.rating||e.review),r=d.filter(e=>!e.rating&&!e.review);o.forEach(e=>{const n=document.createElement("div");n.classList.add("flex","items-start","mb-4","gap-4"),n.innerHTML=`
                        <img src="${e.image_path}" alt="${e.name}" class="w-16 h-16 object-cover rounded-md mt-1" />
                        <div class="flex-1">
                            <label class="font-semibold block mb-1">${e.name}</label>
                            <div class="mb-2">
                                ${Array.from({length:5},(b,p)=>`
                                    <span class="${p<e.rating?"text-yellow-400":"text-gray-300"}">&#9733;</span>
                                `).join("")}
                            </div>
                            <p class="text-sm text-gray-600">${e.review||""}</p>
                        </div>
                    `,u.appendChild(n)}),r.length>0?(L.classList.remove("hidden"),w.innerText="Cancel",r.forEach(e=>{const n=document.createElement("div");n.classList.add("flex","items-start","mb-4","gap-4"),n.innerHTML=`
                            <img src="${e.image_path}" alt="${e.name}" class="w-20 h-20 object-cover rounded-md mt-1" />
                            <div class="flex-1">
                                <label class="font-semibold block mb-1">${e.name}</label>
                                <div class="mb-2">
                                    ${Array.from({length:5},(b,p)=>`
                                        <span class="star text-gray-300 cursor-pointer" data-index="${p+1}" data-product-id="${e.product_id}">&#9733;</span>
                                    `).join("")}
                                </div>
                                <textarea name="reviews[${e.product_id}]" rows="2" class="w-full border rounded p-2 text-sm" placeholder="Write a review (optional)"></textarea>
                            </div>
                        `,u.appendChild(n)})):(L.classList.add("hidden"),w.innerText="Close"),m.classList.remove("hidden")}else if(a==="pending"){const d=await(await fetch(`/orders/${s}/products`)).json(),o=document.getElementById("edit-product-list");o.innerHTML="";const r=new Set;d.forEach(e=>{if(r.has(e.id))return;r.add(e.id);const n=document.createElement("div");n.classList.add("flex","items-center","justify-between","space-x-4","mb-4"),n.innerHTML=`
                    <div class="flex items-center space-x-4 w-1/2">
                    <img src="${e.image_path}" alt="${e.name}" class="w-20 h-20 object-cover rounded-md border" />
                     <label class="font-semibold">${e.name}</label>
                     </div>
                     <input type="number" min="1" name="items[${e.id}]" value="${e.quantity}" class="w-20 border rounded px-2 py-1 text-right" />
                    <button type="button" class="remove-item bg-red-600 text-white px-4 py-2 rounded" data-product-id="${e.id}">Remove</button>
                    `,o.appendChild(n)}),o.querySelectorAll(".remove-item").forEach(e=>{e.addEventListener("click",()=>{var n;(n=e.closest("div.flex"))==null||n.remove()})}),document.getElementById("edit-form").action=`/orders/${s}`,document.getElementById("cancel-order-btn").dataset.orderId=s,g.classList.remove("hidden")}else a==="shipped"?v.classList.remove("hidden"):a==="canceled"&&y.classList.remove("hidden")})}),document.addEventListener("click",function(t){var s;if(t.target.classList.contains("star")){const a=parseInt(t.target.dataset.index),c=t.target.dataset.productId;(s=document.querySelector(`input[name="rating[${c}]"]`))==null||s.setAttribute("value",a),document.querySelectorAll(`.star[data-product-id="${c}"]`).forEach((d,o)=>{d.classList.toggle("text-yellow-400",o<a),d.classList.toggle("text-gray-300",o>=a)})}t.target.id==="close-thank-you"&&h.classList.add("hidden"),t.target.classList.contains("close-modal")&&(m.classList.add("hidden"),v.classList.add("hidden"),y.classList.add("hidden"),g.classList.add("hidden"),l())}),f.addEventListener("submit",async function(t){t.preventDefault();const s=new FormData(this);(await(await fetch(this.action,{method:"POST",headers:{"X-CSRF-TOKEN":s.get("_token"),Accept:"application/json"},body:s})).json()).message&&(m.classList.add("hidden"),h.classList.remove("hidden"))}),document.getElementById("edit-form").addEventListener("submit",async function(t){t.preventDefault();const s=this.querySelectorAll('input[name^="items["]'),a={};s.forEach(d=>{const o=d.name.match(/^items\[(\d+)\]$/);if(o){const r=o[1],e=parseInt(d.value);!isNaN(e)&&e>0&&(a[r]=e)}});const c=document.querySelector('input[name="_token"]').value,i=await fetch(this.action,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c,Accept:"application/json"},body:JSON.stringify({items:a})});if(i.ok)alert("Order updated successfully!"),window.location.reload();else{const d=await i.json();alert(d.message||"Failed to update order.")}}),document.querySelectorAll(".close-modal").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".fixed.inset-0").forEach(s=>{s.classList.add("hidden")}),l()})}),document.addEventListener("click",function(t){if(t.target.classList.contains("remove-item")){const s=t.target.closest(".flex");s&&s.remove()}});const E=document.getElementById("cancel-btn");E&&E.addEventListener("click",()=>{document.getElementById("review-modal").classList.add("hidden"),l()}),document.getElementById("cancel-order-btn").addEventListener("click",async function(){const t=this.dataset.orderId;if(!confirm("Are you sure you want to cancel this order?"))return;(await fetch(`/orders/${t}/cancel`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('input[name="_token"]').value,Accept:"application/json"}})).ok?(alert("Order canceled successfully."),location.reload()):alert("Failed to cancel order.")})});
